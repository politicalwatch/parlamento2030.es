<template>
  <form id="search-form" class="form-horizontal" role="form" @submit.prevent="getResults($event)">
    <div class="o-grid">
      <div class="o-grid__col u-12 u-padding-bottom-4">
        <div class="c-select-label u-block">
          <label for="topic">ODS/SDG</label>
          <multiselect
            selectedLabel="Seleccionado"
            selectLabel=""
            deselectLabel="Pulsa para deseleccionar"
            @select="fillSubtopicsAndTags"
            @remove="clearSubtopicsAndTags"
            v-model="data.topic"
            :options="topics.map(topic => topic.name)"
            :allow-empty="true"
            name="topic" id="topic" placeholder="Todos">
          </multiselect>
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-select-label u-block" :class="{ 'c-select-label--disabled' : !this.subtopics.length }">
          <label for="subtopics">Metas</label>
          <multiselect
            selectedLabel="Seleccionada"
            selectLabel=""
            deselectLabel="Pulsa para deseleccionar"
            @select="addSubtopicToTagsFilter"
            @remove="removeSubtopicToTagsFilter"
            v-model="data.subtopics"
            :multiple="true"
            :options="subtopics"
            :allow-empty="true"
            :disabled="!this.subtopics.length"
            :placeholder="this.subtopics.length ? 'Todos' : 'Selecciona previamente un ODS/SDG'"
            name="subtopics" id="subtopics" >
          </multiselect>
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-select-label u-block" :class="{ 'c-select-label--disabled' : !this.filteredTags.length }">
          <label for="tags">Etiquetas</label>
          <multiselect
          selectedLabel="Seleccionada"
          selectLabel=""
          deselectLabel="Pulsa para deseleccionar"
          v-model="data.tags"
          :multiple="true"
          :options="filteredTags"
          :allow-empty="true"
          :disabled="!this.filteredTags.length"
          :placeholder="this.filteredTags.length ? 'Todos' : 'Selecciona previamente un ODS/SDG'"
          name="tags" id="tags" >
        </multiselect>
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-select-label u-block">
          <label for="author">Autor</label>
          <multiselect
            selectedLabel="Seleccionado"
            selectLabel=""
            deselectLabel="Pulsa para deseleccionar"
            v-model="data.author"
            :options="groups.map(group => group.name || group)"
            :allow-empty="true"
            name="author" id="author" placeholder="Todos">
          </multiselect>
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-select-label u-block">
          <label for="author_deputies">Diputado/a</label>
          <multiselect
            selectedLabel="Seleccionado"
            selectLabel=""
            deselectLabel="Pulsa para deseleccionar"
            v-model="data.deputy"
            :options="deputies"
            :allow-empty="true"
            name="deputy" id="deputy" placeholder="Apellidos, Nombre">
          </multiselect>
        </div>
      </div>
    </div> <!-- /.o-grid -->
    <div class="o-grid" v-show="advanced">
      <div class="o-grid__col u-12 u-4@sm u-padding-bottom-4">
        <div class="c-datepicker-label u-block">
          <label for="startdate">Desde</label>
          <datepicker
            :value="moment(this.data.startdate, 'YYYY-MM-DD').format('DD/MMM/YYYY')" @selected="selectStartDate"
            @cleared="clearStartDate"
            placeholder="dd/mm/YYYY" format="dd/MM/yyyy" name="startdate">
          </datepicker>
        </div>
      </div>
      <div class="o-grid__col u-12 u-4@sm u-padding-bottom-4">
        <div class="c-datepicker-label u-block">
          <label for="enddate">Hasta</label>
          <datepicker
            :value="moment(this.data.enddate, 'YYYY-MM-DD').format('DD/MMM/YYYY')"
            @selected="selectEndDate"
            @cleared="clearEndDate"
            placeholder="dd/mm/YYYY" format="dd/MM/yyyy" name="enddate">
          </datepicker>
        </div>
      </div>
      <div class="o-grid__col u-12 u-4@sm u-padding-bottom-4">
        <div class="c-select-label u-block">
          <label for="status">Estado</label>
          <multiselect
            selectedLabel="Seleccionado"
            selectLabel=""
            deselectLabel="Pulsa para deseleccionar"
            v-model="data.status"
            :options="status"
            :allow-empty="true"
            name="status" id="status" placeholder="Cualquiera">
          </multiselect>
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-select-label u-block">
          <label for="place">Lugar</label>
          <multiselect
            selectedLabel="Seleccionado"
            selectLabel=""
            deselectLabel="Pulsa para deseleccionar"
            v-model="data.place"
            :options="places"
            :allow-empty="true"
            name="place" id="place" placeholder="Cualquiera">
          </multiselect>
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-select-label u-block">
          <label for="type">Tipo</label>
          <multiselect
            selectedLabel="Seleccionado"
            selectLabel=""
            deselectLabel="Pulsa para deseleccionar"
            v-model="data.type"
            :options="types"
            :allow-empty="true"
            name="type" id="type" placeholder="Cualquiera">
          </multiselect>
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-input-label u-block">
          <label for="reference">Tipo</label>
          <input v-model="data.reference" type="text" id="reference" name="reference" placeholder="Ej.: 121/000001">
        </div>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <div class="c-input-label u-block">
          <label for="title">Tipo</label>
          <input v-model="data.title" type="text" id="title" name="title" placeholder="Nota: Se admiten expresiones regulares">
        </div>
      </div>
    </div> <!-- /.o-grid -->
    <div class="o-grid">
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4">
        <a href="#" class="c-button u-padding-left-0" @click.prevent="toggleAdvanced">
          <tipi-icon icon="advanced" />
          <span v-if="!advanced">Mostrar búsqueda avanzada</span>
          <span v-else>Ocultar búsqueda avanzada</span>
        </a>
      </div>
      <div class="o-grid__col u-12 u-6@sm u-padding-bottom-4  u-text-right">
        <button class="c-button c-button--primary" type="submit">Buscar</button>
      </div>
    </div>
  </form>
</template>

<script>
import Datepicker from 'vuejs-datepicker';
import Multiselect from 'vue-multiselect'
import { TipiIcon } from 'tipi-uikit';
import api from '@/api'
import { mapGetters, mapState } from 'vuex';

const moment = require('moment');

export default {
  name: 'searchForm',
  components: {
    Datepicker,
    Multiselect,
    TipiIcon,
  },
  props: {
    data: Object,
  },
  data: function() {
    return {
      subtopics: [],
      tags: [],
      errors: null,
      moment: moment,
      selectedSubtopics: [],
      filteredTags: [],
      advanced: false,
    }
  },
  computed: {
    ...mapGetters({
      deputies: 'allDeputiesName',
      groups: 'allParliamentaryGroupsWithGoverment',
    }),
    ...mapState({
      topics: 'allTopics',
      places: 'allPlaces',
      types: 'allTypes',
      status: 'allStatus',
    })
  },
  methods: {
    fillSubtopicsAndTags: function(selectedTopic, clearValues) {
      if (clearValues) {
        this.data.subtopics = [];
        this.data.tags = [];
      }
      const currentTopic = this.topics.find(topic => topic.name === selectedTopic);
      this.getSubtopicsAndTags(currentTopic.id);
    },
    clearSubtopicsAndTags: function() {
      this.subtopics = [];
      this.selectedSubtopics = [];
      this.tags = [];
      this.filteredTags = [];
      this.data.subtopics = [];
      this.data.tags = [];
    },
    clearStartDate: function() {
      this.data.startdate = '';
    },
    clearEndDate: function() {
      this.data.enddate = '';
    },
    selectStartDate: function(date) {
      this.data.startdate = moment(date).format('YYYY-MM-DD');
    },
    selectEndDate: function(date) {
      this.data.enddate = moment(date).format('YYYY-MM-DD');
    },
    getSubtopicsAndTags: function(topicID) {
      api.getTags(topicID)
        .then(tags => {
          this.subtopics = [...new Set(tags.map(tag => tag.subtopic))];
          this.tags = tags;
          this.filteredTags = this.tags.map(tag => tag.tag);
        })
        .catch(error => this.errors = error);
    },
    filterTags: function() {
      let filtered = (this.selectedSubtopics.length) ?
        (tag => this.selectedSubtopics.indexOf(tag.subtopic) !== -1)
        : (() => true);
      this.filteredTags = this.tags.filter(filtered).map(tag => tag.tag);
    },
    addSubtopicToTagsFilter: function(selectedSubtopic) {
      this.data.tags = [];
      this.selectedSubtopics.push(selectedSubtopic);
      this.filterTags();
    },
    removeSubtopicToTagsFilter: function(removedSubtopic) {
      this.data.tags = [];
      this.selectedSubtopics.splice(this.selectedSubtopics.indexOf(removedSubtopic), 1);
      this.filterTags();
    },
    getResults: function(event) {
      this.$emit('getResults', event);
    },
    prepareForm: function() {
      if (this.data.topic) {
        this.fillSubtopicsAndTags(this.data.topic, false);
      }
    },
    toggleAdvanced: function() {
      this.advanced = !this.advanced;
    }
  },
  created: function() {
    if (this.$route.name == "results") {
      this.$emit('getResults');
    }
    this.prepareForm();
  },
}
</script>

<style scoped lang="scss">
</style>
